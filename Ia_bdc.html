<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>IA Base de connaissance – RFX</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    :root { --rfx-blue: #0055a4; }
    .sncftop { background-color: var(--rfx-blue) !important; padding: 12px 0; color: white; }
    .chat-window { border-radius: 12px; border: 1px solid #dee2e6; background: #fff; height: 650px; display: flex; flex-direction: column; }
    .chat-area { flex-grow: 1; overflow-y: auto; background-color: #f8f9fa; padding: 20px; display: flex; flex-direction: column; }
    .msg-user { background: var(--rfx-blue); color: white; padding: 12px 18px; border-radius: 18px 18px 2px 18px; margin-bottom: 15px; align-self: flex-end; max-width: 80%; }
    .msg-ai { background: white; border: 1px solid #dee2e6; padding: 12px 18px; border-radius: 18px 18px 18px 2px; margin-bottom: 15px; align-self: flex-start; max-width: 85%; border-left: 5px solid #0088ce; }
    .spin { animation: rotation 2s infinite linear; }
    @keyframes rotation { from { transform: rotate(0deg); } to { transform: rotate(359deg); } }
    .error-alert { background-color: #f8d7da; color: #721c24; }
  </style>
</head>
<body>

<nav class="navbar sncftop mb-4 shadow-sm">
  <div class="container">
    <span class="fw-bold"><i class="bi bi-robot me-2"></i> CENTRE D'ASSISTANCE RFX</span>
  </div>
</nav>

<main class="container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <!-- Alerte de configuration -->
      <div id="config-alert" class="alert alert-warning mb-3 d-none">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Configuration requise :</strong> Veuillez ajouter votre clé API Gemini dans le fichier .env
      </div>

      <div class="chat-window shadow">
        <div id="chat-display" class="chat-area">
          <div class="msg-ai">
            <strong>Assistant IA :</strong><br>
            Bonjour. Je suis prêt à analyser votre base de connaissance pour répondre à vos questions.
          </div>
        </div>
        
        <div id="ai-status" class="px-4 py-2 d-none text-primary small bg-white border-top">
          <i class="bi bi-arrow-repeat spin me-1"></i> Traitement de votre demande...
        </div>

        <div class="p-3 border-top bg-white">
          <div class="input-group">
            <input type="text" id="user-query" class="form-control border-0 bg-light" placeholder="Votre question technique..." onkeypress="if(event.key === 'Enter') askAI()">
            <button class="btn btn-primary px-4 rounded-pill ms-2" type="button" onclick="askAI()">
              <i class="bi bi-send-fill"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="mt-3 text-muted small text-center">
        <i class="bi bi-info-circle me-1"></i> Cette application accède à votre base de connaissance publique via une URL sécurisée.
      </div>
    </div>
  </div>
</main>

<script>
    // ⚠️ IMPORTANT : Les clés API NE DOIVENT PAS être dans le code client
    // Utilisez un backend pour stocker les clés sécurisées
    // Pour le développement local, configurez via variables d'environnement

    const KNOWLEDGE_BASE_URL = "https://raw.githubusercontent.com/mikefri/backup_GLPI/refs/heads/main/KNOWLEDGE_BASE.md";
    const GEMINI_API_KEY = ""; // À configurer de manière sécurisée
    
    let knowledgeBaseCache = null;

    // Vérifier la configuration au chargement
    window.addEventListener('load', () => {
        if (!GEMINI_API_KEY) {
            document.getElementById('config-alert').classList.remove('d-none');
        }
    });

    async function fetchKnowledgeBase() {
        if (knowledgeBaseCache) return knowledgeBaseCache;
        
        try {
            const response = await fetch(KNOWLEDGE_BASE_URL);
            if (!response.ok) {
                throw new Error(`Erreur HTTP ${response.status}: Impossible de charger la base de connaissance`);
            }
            knowledgeBaseCache = await response.text();
            return knowledgeBaseCache;
        } catch (error) {
            throw new Error(`Impossible d'accéder à la base de connaissance: ${error.message}`);
        }
    }

    async function askAI() {
        const input = document.getElementById('user-query');
        const chat = document.getElementById('chat-display');
        const status = document.getElementById('ai-status');
        const query = input.value.trim();
        
        if (!query) return;

        // Vérifier la clé API
        if (!GEMINI_API_KEY) {
            chat.innerHTML += `
                <div class="msg-user">${query}</div>
                <div class="alert alert-warning mt-2 mx-4 small">
                    ⚠️ Clé API Gemini non configurée. Veuillez ajouter GEMINI_API_KEY.
                </div>`;
            input.value = "";
            chat.scrollTop = chat.scrollHeight;
            return;
        }

        // Afficher le message utilisateur
        chat.innerHTML += `<div class="msg-user">${escapeHtml(query)}</div>`;
        input.value = "";
        status.classList.remove('d-none');
        chat.scrollTop = chat.scrollHeight;

        try {
            // Charger la base de connaissance
            const kbText = await fetchKnowledgeBase();

            // Appel à Gemini API
            const systemPrompt = `Tu es un expert technique spécialisé dans le support informatique. 
Réponds toujours en français.
Utilise UNIQUEMENT les informations contenues dans la base de connaissance fournie.
Si la réponse n'est pas dans la base de connaissance, indique-le clairement.
Sois concis et pertinent.`;

            const response = await fetch(
                `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${GEMINI_API_KEY}`,
                {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        systemInstruction: { parts: [{ text: systemPrompt }] },
                        contents: [{
                            parts: [{
                                text: `Base de connaissance:\n\n${kbText}\n\n---\n\nQuestion de l'utilisateur: ${query}`
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 1024
                        }
                    })
                }
            );

            const data = await response.json();
            
            if (data.error) {
                throw new Error(`Erreur API Gemini: ${data.error.message}`);
            }
            
            if (!data.candidates || !data.candidates[0].content.parts[0]) {
                throw new Error("Réponse invalide de l'API Gemini");
            }

            const answer = data.candidates[0].content.parts[0].text;

            status.classList.add('d-none');
            chat.innerHTML += `
                <div class="msg-ai">
                    <strong class="text-primary small">Expert IA :</strong><br>
                    ${escapeHtml(answer).replace(/\n/g, '<br>')}
                </div>`;

        } catch (error) {
            console.error('Erreur:', error);
            status.classList.add('d-none');
            chat.innerHTML += `
                <div class="alert alert-danger mx-4 mt-2 small">
                    ❌ Erreur: ${escapeHtml(error.message)}
                </div>`;
        }
        
        chat.scrollTop = chat.scrollHeight;
    }

    // Fonction de sécurité pour éviter les injections XSS
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
