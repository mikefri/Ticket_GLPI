<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Assistant GLPI</title>

  <!-- Bootstrap + Icônes -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="icon" type="image/png" href="./assets/img/GLPI.png">

  <style>
    /* ===== Thème SNCF – repris de styles.css ===== */
    :root {
      --brand:           #CA005D;
      --brand-dark:      #6A1B3F;
      --bg-soft:         #F4F4F4;
      --ink:             #333333;
      --chat-user-bg:    linear-gradient(135deg, #CA005D 0%, #6A1B3F 100%);
      --chat-admin-bg:   #ffffff;
    }

    html, body { height: 100%; }
    body { background: var(--bg-soft); color: var(--ink); }

    /* ── NAVBAR ── */
    .navbar.sncftop               { background-color: var(--brand); }
    .navbar.sncftop .nav-link,
    .navbar.sncftop .navbar-brand,
    .navbar.sncftop .navbar-text  { color: #fff !important; }
    .navbar.sncftop .nav-link:hover,
    .navbar.sncftop .nav-link.active { opacity: .85; }
    .brand-logo { height: 26px; width: auto; margin-right: .5rem; vertical-align: middle; }

    /* ── BOUTONS ── */
    .btn-primary             { background-color: var(--brand); border-color: var(--brand); }
    .btn-primary:hover       { background-color: var(--brand-dark); border-color: var(--brand-dark); }
    .btn-outline-primary     { color: var(--brand); border-color: var(--brand); }
    .btn-outline-primary:hover { background-color: var(--brand); color: #fff; }

    /* ── CARTES ── */
    .card.soft       { border: 1px solid #eaeaea; box-shadow: 0 4px 18px rgba(0,0,0,.05); }
    .card-header.soft { background: #fff; border-bottom: 1px solid #eee; }

    /* ── AVATAR ── */
    .avatar-circle {
      width: 32px; height: 32px; border-radius: 50%;
      background: rgba(255,255,255,.25); color: #fff;
      display: flex; align-items: center; justify-content: center;
      font-weight: 600;
    }

    /* ──────────────────────────────────────────
       ZONE DE CHAT
    ────────────────────────────────────────── */
    #chat-container {
      display: flex;
      flex-direction: column;
      height: 540px;
      background: #f8f9fa;
      border-radius: 0 0 8px 8px;
      border-top: 1px solid #e9ecef;
    }

    #chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    /* Message container */
    .chat-message             { display: flex; width: 100%; }
    .chat-message.user-message  { justify-content: flex-end; }
    .chat-message.admin-message { justify-content: flex-start; }

    /* Bulle */
    .chat-bubble {
      max-width: 72%;
      padding: .75rem 1rem;
      border-radius: 16px;
      background: var(--chat-admin-bg);
      border: 1px solid #dee2e6;
      box-shadow: 0 1px 3px rgba(0,0,0,.08);
      word-break: break-word;
    }
    .chat-message.user-message .chat-bubble {
      background: var(--chat-user-bg);
      color: white;
      border: none;
      border-radius: 16px 16px 4px 16px;
    }
    .chat-message.admin-message .chat-bubble {
      border-radius: 16px 16px 16px 4px;
    }

    .chat-author {
      font-weight: 600;
      font-size: .8rem;
      margin-bottom: .25rem;
    }
    .chat-message.user-message .chat-author  { color: rgba(255,255,255,.85); }
    .chat-message.admin-message .chat-author { color: var(--brand); }

    .chat-text {
      word-wrap: break-word;
      line-height: 1.55;
      margin-bottom: .25rem;
      white-space: pre-wrap;
    }
    .chat-time {
      font-size: .7rem;
      opacity: .6;
      text-align: right;
    }

    /* Zone de saisie */
    #chat-input-area {
      padding: 1rem;
      border-top: 1px solid #e9ecef;
      background: white;
      border-radius: 0 0 8px 8px;
    }
    .chat-input-wrapper {
      display: flex;
      gap: .75rem;
      align-items: flex-end;
    }
    #questionInput {
      flex: 1;
      resize: none;
      border-radius: 20px;
      padding: .75rem 1rem;
      border: 1px solid #dee2e6;
      min-height: 44px;
      max-height: 120px;
      font-size: .95rem;
      font-family: inherit;
    }
    #questionInput:focus {
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(202,0,93,.15);
      outline: none;
    }
    #sendBtn {
      border-radius: 50%;
      width: 44px; height: 44px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--brand);
      border: none;
      color: white;
      font-size: 1.1rem;
      transition: background .2s, transform .15s;
    }
    #sendBtn:hover:not(:disabled) {
      background: var(--brand-dark);
      transform: scale(1.08);
    }
    #sendBtn:disabled { opacity: .5; cursor: not-allowed; }

    /* Bulle vide / welcome */
    .chat-empty {
      text-align: center;
      color: #6c757d;
      padding: 3rem 1rem;
    }
    .chat-empty i {
      font-size: 3rem;
      opacity: .4;
      display: block;
      margin-bottom: 1rem;
    }

    /* Formatage du texte assistant */
    .chat-text strong { font-weight: 700; }
    .chat-text code {
      background: #e9ecef;
      padding: 1px 4px;
      border-radius: 4px;
      font-family: monospace;
      font-size: .9em;
    }
    .chat-text pre {
      background: #2d3748;
      color: #e2e8f0;
      padding: 12px;
      border-radius: 8px;
      overflow-x: auto;
      margin: 8px 0;
      font-size: .85em;
    }
    .chat-text li { margin-left: 1.2rem; list-style: disc; }

    /* Animation chargement */
    .loading-dots::after {
      content: '…';
      animation: blink 1.2s infinite;
    }
    @keyframes blink {
      0%, 100% { opacity: 0; }
      50%       { opacity: 1; }
    }

    /* Scrollbar */
    #chat-messages::-webkit-scrollbar { width: 6px; }
    #chat-messages::-webkit-scrollbar-track { background: transparent; }
    #chat-messages::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    #chat-messages::-webkit-scrollbar-thumb:hover { background: #aaa; }

    /* Titre + sous-titre hero */
    .hero-title { font-weight: 700; letter-spacing: .2px; }
    .hero-sub   { color: #6c757d; }

    footer { color: #6c757d; }

    /* ── RESPONSIVE ── */
    @media (max-width: 768px) {
      #chat-container { height: 400px; }
      .chat-bubble    { max-width: 88%; }
      #chat-messages  { padding: 1rem; }
    }
  </style>
</head>
<body>

<!-- ══════════════════════════════════════════
     NAVBAR – identique à index.html
══════════════════════════════════════════ -->
<nav class="navbar navbar-expand-lg sncftop">
  <div class="container">
    <!-- Logo + titre -->
    <a class="navbar-brand d-flex align-items-center" href="index.html">
      <img src="assets/img/GLPI.png" alt="Logo" class="brand-logo me-2">
      <span class="fw-semibold">Centre d'assistance</span>
    </a>

    <!-- Burger mobile -->
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsMain"
            aria-controls="navbarsMain" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon" style="filter:invert(1);"></span>
    </button>

    <!-- Contenu -->
    <div class="collapse navbar-collapse" id="navbarsMain">
      <!-- Liens principaux (centrés) -->
      <ul class="navbar-nav mx-auto mb-2 mb-lg-0">
        <li class="nav-item">
          <a class="nav-link" href="index.html">Demander une assistance</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="tickets.html">Mes demandes</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="profil.html">Mon profil</a>
        </li>
        <!-- Liens admin (masqués par défaut, JS les affiche) -->
        <li class="nav-item d-none" id="nav-admin">
          <a class="nav-link" href="admin.html">Administration</a>
        </li>
        <li class="nav-item d-none" id="nav-users">
          <a class="nav-link" href="users.html">Utilisateurs &amp; Rôles</a>
        </li>
        <li class="nav-item d-none" id="nav-stats">
          <a class="nav-link" href="Stats v2.html">Statistiques</a>
        </li>
      </ul>

      <!-- Zone droite : connexion / logout / avatar / badge / nom -->
      <div class="d-flex align-items-center gap-3 ms-lg-3">
        <span class="navbar-text small d-none" id="user-display"></span>
        <span id="badge-admin" class="badge rounded-pill bg-warning text-dark d-none">
          <i class="bi bi-shield-lock-fill me-1"></i>Admin
        </span>
        <div id="avatar" class="avatar-circle d-none"></div>
        <a href="login.html" id="btn-login" class="btn btn-light btn-sm">Se connecter</a>
        <button id="btn-logout" class="btn btn-outline-light btn-sm d-none">Se déconnecter</button>
      </div>
    </div>
  </div>
</nav>

<!-- ══════════════════════════════════════════
     CONTENU PRINCIPAL
══════════════════════════════════════════ -->
<main class="container my-4">

  <h3 class="hero-title text-center mb-2">
    <i class="bi bi-robot me-2" style="color:var(--brand);"></i>Assistant GLPI
  </h3>
  <p class="hero-sub text-center mb-4">
    Posez vos questions sur la documentation. L'assistant analyse la base de connaissances et vous répond instantanément.
  </p>

  <!-- Carte principale -->
  <div class="card soft mb-4">
    <div class="card-header soft d-flex align-items-center justify-content-between">
      <h5 class="mb-0">
        <i class="bi bi-chat-dots me-2" style="color:var(--brand);"></i>Conversation
      </h5>
      <span class="text-muted small">
        <i class="bi bi-circle-fill me-1 text-success" style="font-size:.6rem;"></i>Connecté à la base de connaissances
      </span>
    </div>

    <!-- Zone de messages -->
    <div id="chat-container">
      <div id="chat-messages">

        <!-- Message de bienvenue -->
        <div class="chat-message admin-message">
          <div class="chat-bubble">
            <div class="chat-author"><i class="bi bi-robot me-1"></i>Assistant GLPI</div>
            <div class="chat-text">Bonjour ! Je suis votre assistant.<br>
Posez-moi vos questions. Je suis là pour vous aider.</div>
            <div class="chat-time" id="welcome-time"></div>
          </div>
        </div>

      </div><!-- /#chat-messages -->

      <!-- Zone de saisie -->
      <div id="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea
            id="questionInput"
            class="form-control"
            placeholder="Ex : Le commentaire EMA c'est quoi ?"
            rows="1"
            autocomplete="off"
          ></textarea>
          <button id="sendBtn" title="Envoyer">
            <i class="bi bi-send-fill"></i>
          </button>
        </div>
        
      </div>
    </div><!-- /#chat-container -->
  </div><!-- /.card -->



</main>

<footer class="text-center py-4">
  <small>© 2026 • Centre d'assistance – Méthodes Logistiques</small>
</footer>

<!-- ══════════════════════════════════════════
     SCRIPTS
══════════════════════════════════════════ -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
  /* ── Helpers ── */
  const questionInput = document.getElementById('questionInput');
  const sendBtn       = document.getElementById('sendBtn');
  const messagesDiv   = document.getElementById('chat-messages');

  // Heure de bienvenue
  document.getElementById('welcome-time').textContent = formatTime(new Date());

  /* ── Auto-resize textarea ── */
  questionInput.addEventListener('input', () => {
    questionInput.style.height = 'auto';
    questionInput.style.height = Math.min(questionInput.scrollHeight, 120) + 'px';
  });

  /* ── Envoi avec Entrée (Maj+Entrée = saut de ligne) ── */
  questionInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      askQuestion();
    }
  });

  sendBtn.addEventListener('click', askQuestion);

  /* ── Suggestions ── */
  function insertSuggestion(btn) {
    questionInput.value = btn.textContent.trim();
    questionInput.focus();
    askQuestion();
  }

  /* ── Envoi d'une question ── */
  async function askQuestion() {
    const question = questionInput.value.trim();
    if (!question) return;

    // Message utilisateur
    addMessage('user', 'Vous', question);
    questionInput.value = '';
    questionInput.style.height = 'auto';
    setUI(false);

    // Indicateur de chargement
    const loadingId = 'loading-' + Date.now();
    addLoadingMessage(loadingId);

    try {
      const response = await fetch('/api/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question })
      });

      const data = await response.json();
      document.getElementById(loadingId)?.remove();

      if (data.error) {
        addMessage('admin', 'Assistant GLPI', `❌ Erreur : ${data.error}`);
      } else {
        addMessage('admin', 'Assistant GLPI', data.answer, true);
      }

    } catch (err) {
      document.getElementById(loadingId)?.remove();
      addMessage('admin', 'Assistant GLPI', '❌ Impossible de contacter le serveur. Vérifiez votre connexion.');
      console.error(err);
    } finally {
      setUI(true);
      questionInput.focus();
    }
  }

  /* ── Ajouter un message dans le chat ── */
  function addMessage(type, author, content, isHtml = false) {
    const wrapper = document.createElement('div');
    wrapper.className = `chat-message ${type === 'user' ? 'user-message' : 'admin-message'}`;

    const authorIcon = type === 'user'
      ? '<i class="bi bi-person-fill me-1"></i>'
      : '<i class="bi bi-robot me-1"></i>';

    wrapper.innerHTML = `
      <div class="chat-bubble">
        <div class="chat-author">${authorIcon}${author}</div>
        <div class="chat-text">${isHtml ? formatMarkdown(content) : escapeHtml(content)}</div>
        <div class="chat-time">${formatTime(new Date())}</div>
      </div>`;

    messagesDiv.appendChild(wrapper);
    scrollToBottom();
  }

  /* ── Bulle de chargement animée ── */
  function addLoadingMessage(id) {
    const wrapper = document.createElement('div');
    wrapper.className = 'chat-message admin-message';
    wrapper.id = id;
    wrapper.innerHTML = `
      <div class="chat-bubble">
        <div class="chat-author"><i class="bi bi-robot me-1"></i>Assistant GLPI</div>
        <div class="chat-text text-muted">
          <span class="loading-dots">Analyse de la base de connaissances</span>
        </div>
      </div>`;
    messagesDiv.appendChild(wrapper);
    scrollToBottom();
  }

  /* ── Formatage Markdown simple ── */
  function formatMarkdown(text) {
    text = escapeHtml(text);
    // Blocs de code
    text = text.replace(/```[\w]*\n([\s\S]*?)```/g, '<pre><code>$1</code></pre>');
    // Code inline
    text = text.replace(/`([^`]+)`/g, '<code>$1</code>');
    // Gras
    text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
    // Listes à puces
    text = text.replace(/^[\s]*[-*]\s+(.*)$/gm, '<li>$1</li>');
    // Sauts de ligne (hors pre)
    text = text.replace(/\n(?!<\/?(pre|code|li))/g, '<br>');
    return text;
  }

  function escapeHtml(text) {
    return text
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;');
  }

  function formatTime(date) {
    return date.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }

  function scrollToBottom() {
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  }

  function setUI(enabled) {
    questionInput.disabled = !enabled;
    sendBtn.disabled = !enabled;
  }
</script>

</body>
</html>
